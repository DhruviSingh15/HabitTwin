{% extends "base.html" %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-800">Achievements</h1>
        <p class="text-gray-600">Track your progress and unlock badges as you build healthy habits</p>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column - User Achievements -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Your Achievements</h2>
                    <div class="text-gray-600">
                        <span class="font-bold text-indigo-600">{{ user_achievements|length }}</span> / {{ user_achievements|length + locked_achievements|length }} unlocked
                    </div>
                </div>
                
                {% if user_achievements %}
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                        {% for user_achievement in user_achievements %}
                            <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-lg p-4 text-center transform transition-transform hover:scale-105 shadow-sm hover:shadow-md">
                                <div class="w-16 h-16 mx-auto mb-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 flex items-center justify-center text-white text-2xl">
                                    <i class="fas {% if user_achievement.achievement.icon %}{{ user_achievement.achievement.icon }}{% else %}fa-trophy{% endif %}"></i>
                                </div>
                                <div class="bg-white rounded-lg p-3 shadow-sm">
                                    <h3 class="font-bold text-indigo-800 mb-1">{{ user_achievement.achievement.name }}</h3>
                                    <p class="text-xs text-indigo-600 mb-2">{{ user_achievement.achievement.description }}</p>
                                    <div class="text-xs text-gray-500 flex items-center justify-center">
                                        <i class="far fa-calendar-check mr-1"></i>
                                        {{ user_achievement.earned_date.strftime('%b %d, %Y') }}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="bg-gray-50 rounded-lg p-6 text-center">
                        <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-gray-200 flex items-center justify-center text-gray-400 text-3xl">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <p class="text-gray-600 mb-4">You haven't earned any achievements yet. Keep tracking your habits to unlock badges!</p>
                        <a href="{{ url_for('habits.view_habits') }}" class="inline-block px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">Track Habits</a>
                    </div>
                {% endif %}
            </div>
            
            <!-- Locked Achievements -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Achievements to Unlock</h2>
                
                {% if locked_achievements %}
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                        {% for achievement in locked_achievements %}
                            <div class="bg-gray-100 rounded-lg p-4 text-center transform transition-transform hover:scale-105 shadow-sm hover:shadow-md">
                                <div class="w-16 h-16 mx-auto mb-3 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 text-2xl relative">
                                    <i class="fas {% if achievement.icon %}{{ achievement.icon }}{% else %}fa-trophy{% endif %}"></i>
                                    <div class="absolute -bottom-1 -right-1 w-6 h-6 rounded-full bg-gray-300 flex items-center justify-center text-white text-xs">
                                        <i class="fas fa-lock"></i>
                                    </div>
                                </div>
                                <div class="bg-white rounded-lg p-3 shadow-sm">
                                    <h3 class="font-bold text-gray-700 mb-1">{{ achievement.name }}</h3>
                                    <p class="text-xs text-gray-500 mb-3">{{ achievement.description }}</p>
                                    
                                    <!-- Progress bar -->
                                    <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                                        <div class="bg-indigo-400 h-2 rounded-full" style="width: {{ achievement.progress|default(0) }}%"></div>
                                    </div>
                                    
                                    <div class="flex justify-between text-xs text-gray-500 mb-2">
                                        <span>Progress</span>
                                        <span>{{ achievement.progress }}%</span>
                                    </div>
                                    
                                    <div class="text-xs text-gray-600 border-t border-gray-200 pt-2">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        {{ achievement.requirement_text }}
                                    </div>
                                    
                                    {% if achievement.progress == 100 %}
                                    <div class="mt-3">
                                        <button class="claim-reward-btn w-full bg-indigo-500 hover:bg-indigo-600 text-white text-xs font-medium py-2 px-3 rounded transition-colors" data-achievement-id="{{ achievement.id }}" data-achievement-name="{{ achievement.name }}">
                                            <i class="fas fa-award mr-1"></i> Claim Reward
                                        </button>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="bg-gray-50 rounded-lg p-6 text-center">
                        <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-green-100 flex items-center justify-center text-green-500 text-3xl">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <p class="text-gray-600">Congratulations! You've unlocked all available achievements.</p>
                    </div>
                {% endif %}
            </div>
            
            <!-- Challenges Section -->
            <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 mt-6">
                <div class="flex flex-wrap justify-between items-center mb-4 sm:mb-6">
                    <h2 class="text-lg sm:text-xl font-bold text-gray-800">Active Challenges</h2>
                    <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full mt-1 sm:mt-0">New</span>
                </div>
                
                <div class="space-y-4">
                    <!-- Challenge 1: 7-Day Digital Detox -->
                    <div class="border border-indigo-200 rounded-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-3 sm:p-4">
                            <div class="flex flex-wrap justify-between items-start gap-2">
                                <h3 class="font-bold text-base sm:text-lg">7-Day Digital Detox</h3>
                                <div class="bg-white text-indigo-600 text-xs font-bold px-2 py-1 rounded whitespace-nowrap">Ends in 5 days</div>
                            </div>
                            <p class="text-indigo-100 text-xs sm:text-sm mt-1">Complete a full week of digital detox plans</p>
                        </div>
                        <div class="p-3 sm:p-4 bg-white">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs sm:text-sm font-medium text-gray-700">Progress</span>
                                <span class="text-xs sm:text-sm font-medium text-indigo-600">2/7 days</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="bg-indigo-600 h-2.5 rounded-full" style="width: 28%"></div>
                            </div>
                            <div class="mt-3 sm:mt-4 flex flex-wrap justify-between items-center gap-2">
                                <div class="text-xs text-gray-500">
                                    <i class="fas fa-trophy mr-1 text-yellow-500"></i>
                                    <span class="hidden xs:inline">Reward:</span> Digital Wellness Badge + 500 pts
                                </div>
                                <a href="{{ url_for('gamification.challenge_details', challenge_id=1) }}" class="text-xs bg-indigo-100 hover:bg-indigo-200 text-indigo-800 font-medium py-1 px-2 rounded transition-colors">
                                    View Details
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Challenge 2: Morning Routine Master -->
                    <div class="border rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow border-amber-200">
                        <div class="bg-gradient-to-r text-white p-4 from-amber-500 to-amber-600">
                            <div class="flex flex-wrap justify-between items-start gap-2 mb-2">
                                <h3 class="font-bold text-lg">Morning Routine Master</h3>
                                <div class="bg-white text-amber-600 text-xs font-bold px-2 py-1 rounded whitespace-nowrap">Ends in 10 days</div>
                            </div>
                            <p class="text-amber-100 text-sm mt-1">Complete your morning habits before 9 AM for 14 days</p>
                        </div>
                        <div class="p-3 sm:p-4 bg-white">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs sm:text-sm font-medium text-gray-700">Progress</span>
                                <span class="text-xs sm:text-sm font-medium text-amber-600">5/14 days</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="bg-amber-600 h-2.5 rounded-full" style="width: 35%"></div>
                            </div>
                            <div class="mt-3 sm:mt-4 flex flex-wrap justify-between items-center gap-2">
                                <div class="text-xs text-gray-500">
                                    <i class="fas fa-trophy mr-1 text-yellow-500"></i>
                                    <span class="hidden xs:inline">Reward:</span> Early Bird Badge + 750 pts
                                </div>
                                <a href="{{ url_for('gamification.challenge_details', challenge_id=2) }}" class="text-xs bg-amber-100 hover:bg-amber-200 text-amber-800 font-medium py-1 px-2 rounded transition-colors">
                                    View Details
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Challenge 3: Weekend Warrior -->
                    <div class="border border-green-200 rounded-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-green-500 to-teal-600 text-white p-3 sm:p-4">
                            <div class="flex flex-wrap justify-between items-start gap-2">
                                <h3 class="font-bold text-base sm:text-lg">Weekend Warrior</h3>
                                <div class="bg-white text-green-600 text-xs font-bold px-2 py-1 rounded whitespace-nowrap">Ends in 3 days</div>
                            </div>
                            <p class="text-green-100 text-xs sm:text-sm mt-1">Complete all habits on both Saturday and Sunday for 3 weekends</p>
                        </div>
                        <div class="p-3 sm:p-4 bg-white">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs sm:text-sm font-medium text-gray-700">Progress</span>
                                <span class="text-xs sm:text-sm font-medium text-green-600">2/3 weekends</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="bg-green-600 h-2.5 rounded-full" style="width: 66%"></div>
                            </div>
                            <div class="mt-3 sm:mt-4 flex flex-wrap justify-between items-center gap-2">
                                <div class="text-xs text-gray-500">
                                    <i class="fas fa-trophy mr-1 text-yellow-500"></i>
                                    <span class="hidden xs:inline">Reward:</span> Weekend Warrior Badge + 600 pts
                                </div>
                                <a href="{{ url_for('gamification.challenge_details', challenge_id=3) }}" class="text-xs bg-green-100 hover:bg-green-200 text-green-800 font-medium py-1 px-2 rounded transition-colors">
                                    View Details
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 sm:mt-6 text-center">
                    <a href="{{ url_for('gamification.browse_challenges') }}" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium inline-flex items-center">
                        <i class="fas fa-plus-circle mr-1"></i> Browse More Challenges
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Right Column - Stats & Leaderboard -->
        <div>
            <!-- Achievement Stats -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Your Stats</h2>
                
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="text-sm font-medium text-gray-700">Achievement Progress</span>
                            <span class="text-sm font-medium text-gray-700">{{ achievement_percentage }}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-indigo-600 h-2.5 rounded-full" style="width: {{ achievement_percentage|default(0) }}%"></div>
                        </div>
                    </div>
                    
                    <!-- Habit Stats -->
                    <div class="border-b border-gray-200 pb-4">
                        <h3 class="text-md font-semibold text-gray-700 mb-3 flex items-center">
                            <i class="fas fa-check-circle text-green-500 mr-2"></i> Habit Stats
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-indigo-50 p-4 rounded-lg text-center">
                                <p class="text-sm text-gray-600 mb-1">Habits Completed</p>
                                <p class="text-2xl font-bold text-indigo-600">{{ habits_completed }}</p>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg text-center">
                                <p class="text-sm text-gray-600 mb-1">Longest Streak</p>
                                <p class="text-2xl font-bold text-green-600">{{ longest_streak }} days</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div class="bg-purple-50 p-4 rounded-lg text-center">
                                <p class="text-sm text-gray-600 mb-1">Completion Rate</p>
                                <p class="text-2xl font-bold text-purple-600">{{ completion_rate }}%</p>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg text-center">
                                <p class="text-sm text-gray-600 mb-1">Active Habits</p>
                                <p class="text-2xl font-bold text-blue-600">{{ active_habits }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Digital Twin Stats -->
                    <div class="pt-2">
                        <h3 class="text-md font-semibold text-gray-700 mb-3 flex items-center">
                            <i class="fas fa-mobile-alt text-indigo-500 mr-2"></i> Digital Twin Stats
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-indigo-50 p-4 rounded-lg text-center">
                                <p class="text-sm text-gray-600 mb-1">Daily Screen Time</p>
                                <p class="text-2xl font-bold text-indigo-600">{{ daily_screen_time }} min</p>
                            </div>
                            <div class="bg-{{ 'red' if weekly_change > 0 else 'green' }}-50 p-4 rounded-lg text-center">
                                <p class="text-sm text-gray-600 mb-1">Weekly Change</p>
                                <p class="text-2xl font-bold text-{{ 'red' if weekly_change > 0 else 'green' }}-600">
                                    {{ '+' if weekly_change > 0 else '' }}{{ weekly_change }}%
                                </p>
                            </div>
                        </div>
                        
                        <div class="bg-purple-50 p-4 rounded-lg text-center mt-4">
                            <p class="text-sm text-gray-600 mb-1">Most Used App</p>
                            <p class="text-xl font-bold text-purple-600">{{ most_used_app }}</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Leaderboard -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Leaderboard</h2>
                    <a href="{{ url_for('gamification.leaderboard') }}" class="text-indigo-600 hover:text-indigo-800">View Full</a>
                </div>
                
                {% if sidebar_leaderboard %}
                    <div class="space-y-3">
                        {% for user in sidebar_leaderboard %}
                            <div class="flex items-center {% if user.username == current_user.username %}bg-indigo-50{% else %}bg-gray-50{% endif %} p-3 rounded-lg">
                                <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 mr-3">
                                    {{ loop.index }}
                                </div>
                                <div class="flex items-center">
                                    <img src="{{ url_for('static', filename='uploads/profile_pics/' + user.profile_pic) }}" 
                                         alt="Profile" class="w-8 h-8 rounded-full mr-2">
                                    <span class="font-medium {% if user.username == current_user.username %}text-indigo-600{% endif %}">
                                        {{ user.username }}
                                    </span>
                                </div>
                                <div class="ml-auto">
                                    <span class="font-bold">{{ user.achievements_count }}</span>
                                    <span class="text-gray-500 text-sm">achievements</span>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-gray-600 text-center">No leaderboard data available yet.</p>
                {% endif %}
            </div>
            
            <!-- Digital Twin -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Your Digital Twin</h2>
                
                {% if digital_twin %}
                    <div class="bg-indigo-50 rounded-lg p-4 mb-4">
                        <div class="flex items-center mb-3">
                            <div class="w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 text-xl mr-3">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-indigo-800">{{ digital_twin.name }}</h3>
                                <p class="text-xs text-indigo-600">Level {{ digital_twin.level }}</p>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">{{ digital_twin.description }}</p>
                        
                        <div class="flex justify-between mb-1">
                            <span class="text-xs font-medium text-gray-700">Experience</span>
                            <span class="text-xs font-medium text-gray-700">{{ digital_twin.experience }} / {{ digital_twin.next_level_exp }}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-indigo-600 h-2 rounded-full" style="width: {{ ((digital_twin.experience / digital_twin.next_level_exp) * 100)|default(0)|round }}%"></div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-bold text-gray-800 mb-3">Twin vs You</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm">Habits Completed</span>
                                <div class="flex items-center">
                                    <span class="text-indigo-600 font-bold mr-2">{{ digital_twin.habits_completed }}</span>
                                    <span class="text-gray-400">vs</span>
                                    <span class="text-green-600 font-bold ml-2">{{ habits_completed }}</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm">Longest Streak</span>
                                <div class="flex items-center">
                                    <span class="text-indigo-600 font-bold mr-2">{{ digital_twin.longest_streak }}</span>
                                    <span class="text-gray-400">vs</span>
                                    <span class="text-green-600 font-bold ml-2">{{ longest_streak }}</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm">Completion Rate</span>
                                <div class="flex items-center">
                                    <span class="text-indigo-600 font-bold mr-2">{{ digital_twin.completion_rate }}%</span>
                                    <span class="text-gray-400">vs</span>
                                    <span class="text-green-600 font-bold ml-2">{{ completion_rate }}%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="bg-gray-50 rounded-lg p-6 text-center">
                        <p class="text-gray-600 mb-4">You don't have a Digital Twin yet. Create habits and log them to generate your twin!</p>
                        <a href="{{ url_for('gamification.digital_twin') }}" 
                           class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                            View Digital Twin
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Reward Claim Modal -->
    <div id="rewardModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="bg-indigo-500 text-white rounded-t-lg px-6 py-4 flex justify-between items-center">
                <h3 class="font-bold text-lg">Achievement Unlocked!</h3>
                <button id="closeRewardModal" class="text-white hover:text-gray-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6 text-center">
                <div class="mb-4">
                    <div class="w-20 h-20 mx-auto bg-indigo-100 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-award text-4xl text-indigo-500"></i>
                    </div>
                    <h4 id="achievementName" class="text-xl font-bold text-gray-800 mb-2">Achievement Name</h4>
                    <p class="text-gray-600">Congratulations! You've earned this achievement and its rewards.</p>
                </div>
                <div class="bg-gray-100 rounded-lg p-4 mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700">Experience Points</span>
                        <span class="text-sm font-medium text-indigo-600">+100 XP</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-700">Special Badge</span>
                        <span class="text-sm font-medium text-indigo-600">Unlocked</span>
                    </div>
                </div>
                <button id="claimRewardBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-6 rounded">
                    Claim Rewards
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // Modal functionality for achievement rewards
        const rewardModal = document.getElementById('rewardModal');
        const closeRewardModal = document.getElementById('closeRewardModal');
        const claimRewardBtn = document.getElementById('claimRewardBtn');
        const achievementName = document.getElementById('achievementName');
        const claimButtons = document.querySelectorAll('.claim-reward-btn');
        
        // Show modal when Claim Reward button is clicked
        claimButtons.forEach(button => {
            button.addEventListener('click', () => {
                const name = button.getAttribute('data-achievement-name');
                achievementName.textContent = name;
                rewardModal.classList.remove('hidden');
                rewardModal.classList.add('flex');
                
                // Disable the button that was clicked to prevent multiple claims
                button.disabled = true;
                button.classList.remove('bg-indigo-500', 'hover:bg-indigo-600');
                button.classList.add('bg-gray-400');
                button.innerHTML = '<i class="fas fa-check mr-1"></i> Claimed';
            });
        });
        
        // Hide modal when close button is clicked
        closeRewardModal.addEventListener('click', closeRewardModalFunc);
        
        function closeRewardModalFunc() {
            rewardModal.classList.add('hidden');
            rewardModal.classList.remove('flex');
        }
        
        // Claim reward button functionality
        claimRewardBtn.addEventListener('click', () => {
            // In a real app, this would send an AJAX request to claim the reward
            // For now, just close the modal and show a message
            closeRewardModalFunc();
            
            // Create a temporary notification
            const notification = document.createElement('div');
            notification.className = 'fixed bottom-4 right-4 bg-green-100 text-green-700 p-4 rounded-lg shadow-md flex items-center';
            notification.innerHTML = `
                <i class="fas fa-check-circle mr-2"></i>
                <span>Rewards claimed successfully!</span>
                <button class="ml-4 text-gray-500 hover:text-gray-700" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            document.body.appendChild(notification);
            
            // Remove notification after 5 seconds
            setTimeout(() => {
                notification.remove();
            }, 5000);
        });
        
        // Close modal if user clicks outside of it
        rewardModal.addEventListener('click', (e) => {
            if (e.target === rewardModal) {
                closeRewardModalFunc();
            }
        });
    </script>
</div>
{% endblock %}
