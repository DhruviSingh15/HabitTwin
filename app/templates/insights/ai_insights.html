{% extends "base.html" %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">AI Insights</h1>
        <a href="{{ url_for('insights.refresh_insights') }}" 
           class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
            <i class="fas fa-sync-alt mr-2"></i> Refresh Insights
        </a>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column -->
        <div class="lg:col-span-2">
            <!-- Weekly Report Card -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
                <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 px-6">
                    <h2 class="text-2xl font-bold">Weekly Report</h2>
                    <p class="text-indigo-200">{{ report_date }}</p>
                </div>
                <div class="p-6">
                    {% if weekly_report %}
                        <div class="space-y-6">
                            <!-- Overall Score -->
                            <div class="text-center mb-6">
                                <div class="inline-block rounded-full bg-indigo-100 p-3">
                                    <div class="w-24 h-24 rounded-full bg-indigo-600 flex items-center justify-center text-white">
                                        <span class="text-3xl font-bold">{{ weekly_report.overall_score }}</span>
                                    </div>
                                </div>
                                <p class="text-gray-600 mt-2">Overall Wellbeing Score</p>
                            </div>
                            
                            <!-- Habit Performance -->
                            <div>
                                <h3 class="text-lg font-bold text-gray-800 mb-3">Habit Performance</h3>
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <p class="mb-3">{{ weekly_report.habit_summary }}</p>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                                        <div class="bg-white p-3 rounded-lg shadow-sm text-center">
                                            <p class="text-sm text-gray-600 mb-1">Completion Rate</p>
                                            <p class="text-2xl font-bold text-indigo-600">{{ weekly_report.habit_completion_rate }}%</p>
                                        </div>
                                        <div class="bg-white p-3 rounded-lg shadow-sm text-center">
                                            <p class="text-sm text-gray-600 mb-1">Active Habits</p>
                                            <p class="text-2xl font-bold text-indigo-600">{{ weekly_report.active_habits }}</p>
                                        </div>
                                        <div class="bg-white p-3 rounded-lg shadow-sm text-center">
                                            <p class="text-sm text-gray-600 mb-1">Longest Streak</p>
                                            <p class="text-2xl font-bold text-indigo-600">{{ weekly_report.longest_streak }} days</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Screen Time Analysis -->
                            <div>
                                <h3 class="text-lg font-bold text-gray-800 mb-3">Screen Time Analysis</h3>
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <p class="mb-3">{{ weekly_report.screen_time_summary }}</p>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                                        <div class="bg-white p-3 rounded-lg shadow-sm text-center">
                                            <p class="text-sm text-gray-600 mb-1">Daily Average</p>
                                            <p class="text-2xl font-bold text-indigo-600">
                                                {{ (weekly_report.avg_screen_time // 60)|int }}h {{ (weekly_report.avg_screen_time % 60)|int }}m
                                            </p>
                                        </div>
                                        <div class="bg-white p-3 rounded-lg shadow-sm text-center">
                                            <p class="text-sm text-gray-600 mb-1">Change from Last Week</p>
                                            <p class="text-2xl font-bold {% if weekly_report.screen_time_change < 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                                {{ weekly_report.screen_time_change }}%
                                            </p>
                                        </div>
                                        <div class="bg-white p-3 rounded-lg shadow-sm text-center">
                                            <p class="text-sm text-gray-600 mb-1">Most Used App</p>
                                            <p class="text-2xl font-bold text-indigo-600">{{ weekly_report.most_used_app }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Recommendations -->
                            <div>
                                <h3 class="text-lg font-bold text-gray-800 mb-3">Recommendations</h3>
                                <div class="space-y-3">
                                    {% for recommendation in weekly_report.recommendations %}
                                        <div class="bg-indigo-50 p-4 rounded-lg">
                                            <div class="flex">
                                                <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 mr-3">
                                                    <i class="fas fa-lightbulb"></i>
                                                </div>
                                                <div>
                                                    <p class="font-medium text-indigo-800">{{ recommendation.title }}</p>
                                                    <p class="text-sm text-indigo-600">{{ recommendation.description }}</p>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="bg-gray-50 rounded-lg p-6 text-center">
                            <p class="text-gray-600 mb-4">No weekly report available yet. Add more habits and screen time data to generate insights.</p>
                            <a href="{{ url_for('insights.refresh_insights') }}" 
                               class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                                Generate Report
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Habit Correlations -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-4 px-6">
                    <h2 class="text-xl font-bold">Habit & Screen Time Correlations</h2>
                    <p class="text-indigo-200">Discover how your habits and screen time relate</p>
                </div>
                <div class="p-6">
                    {% if correlations %}
                        <div class="space-y-4">
                            {% for correlation in correlations %}
                                <div class="border rounded-lg p-4 hover:shadow-md transition-shadow duration-200">
                                    <h3 class="font-bold text-gray-800 mb-2">{{ correlation.title }}</h3>
                                    <p class="text-gray-600 mb-3">{{ correlation.description }}</p>
                                    <div class="flex items-center">
                                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                                            <div class="bg-indigo-600 h-2.5 rounded-full correlation-bar" data-strength="{{ correlation.strength }}"></div>
                                        </div>
                                        <span class="ml-2 text-sm text-gray-600">{{ correlation.strength }}%</span>
                                    </div>
                                    {% if correlation.impact %}
                                    <div class="mt-3 text-sm">
                                        <span class="font-medium text-indigo-600">Impact:</span> 
                                        <span class="text-gray-700">{{ correlation.impact }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-gray-600 text-center py-4">No correlations found yet. Continue tracking your habits and screen time to discover patterns.</p>
                        <div class="text-center mt-2">
                            <a href="{{ url_for('insights.refresh_insights') }}" class="inline-flex items-center px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-colors duration-200">
                                <i class="fas fa-sync-alt mr-2"></i> Refresh Insights
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Right Column -->
        <div>
            <!-- Digital Wellbeing Insights -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
                <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-4 px-6">
                    <h2 class="text-xl font-bold">Digital Wellbeing</h2>
                    <p class="text-purple-200">Your digital balance insights</p>
                </div>
                <div class="p-6">
                    {% if wellbeing_insights %}
                        <!-- Wellbeing Score -->
                        <div class="text-center mb-6">
                            <div class="inline-block rounded-full bg-purple-100 p-3">
                                <div class="w-20 h-20 rounded-full bg-gradient-to-br from-purple-600 to-indigo-600 flex items-center justify-center text-white">
                                    <span class="text-2xl font-bold">{{ wellbeing_insights.wellbeing_score }}</span>
                                </div>
                            </div>
                            <p class="text-gray-600 mt-2">Digital Wellbeing Score</p>
                        </div>
                        
                        <!-- Wellbeing Score Visualization -->
                        <div class="mb-6">
                            <div id="wellbeingChart" class="w-full h-40"></div>
                        </div>
                        
                        <!-- Wellbeing Summary -->
                        <div class="bg-purple-50 p-4 rounded-lg mb-4">
                            <p class="text-purple-800">{{ wellbeing_insights.summary }}</p>
                        </div>
                        
                        <!-- Detailed Insights -->
                        <div class="space-y-3">
                            <div class="flex items-start">
                                <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 mr-3 mt-1">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-800">Screen Time Trend</p>
                                    <p class="text-sm text-gray-600">{{ wellbeing_insights.screen_time_trend }}</p>
                                </div>
                            </div>
                            
                            <div class="flex items-start">
                                <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 mr-3 mt-1">
                                    <i class="fas fa-power-off"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-800">Detox Impact</p>
                                    <p class="text-sm text-gray-600">{{ wellbeing_insights.detox_impact }}</p>
                                </div>
                            </div>
                            
                            <div class="flex items-start">
                                <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 mr-3 mt-1">
                                    <i class="fas fa-stopwatch"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-800">App Limits</p>
                                    <p class="text-sm text-gray-600">{{ wellbeing_insights.app_limit_effectiveness }}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex flex-wrap gap-2 mt-4">
                            <a href="{{ url_for('wellbeing.digital_detox') }}" 
                               class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm px-3 py-2 rounded-lg">
                                <i class="fas fa-power-off mr-1"></i> Manage Detox
                            </a>
                            <a href="{{ url_for('wellbeing.app_limits') }}" 
                               class="bg-purple-600 hover:bg-purple-700 text-white text-sm px-3 py-2 rounded-lg">
                                <i class="fas fa-stopwatch mr-1"></i> Set App Limits
                            </a>
                        </div>
                    {% else %}
                        <p class="text-gray-600 text-center">No wellbeing insights available yet.</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Personalized Recommendations -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Personalized Recommendations</h2>
                
                {% if recommendations %}
                    <div class="space-y-4">
                        {% for recommendation in recommendations %}
                            <div class="bg-indigo-50 p-4 rounded-lg">
                                <div class="flex items-start">
                                    <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 mr-3 mt-1">
                                        {% if recommendation.category == 'screen_time' %}
                                            <i class="fas fa-mobile-alt"></i>
                                        {% elif recommendation.category == 'app_limit' %}
                                            <i class="fas fa-stopwatch"></i>
                                        {% elif recommendation.category == 'detox' %}
                                            <i class="fas fa-power-off"></i>
                                        {% elif recommendation.category == 'habit' %}
                                            <i class="fas fa-check-circle"></i>
                                        {% else %}
                                            <i class="fas fa-lightbulb"></i>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-indigo-800 mb-1">{{ recommendation.title }}</h3>
                                        <p class="text-sm text-indigo-600">{{ recommendation.description }}</p>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-gray-600 text-center">No personalized recommendations available yet.</p>
                {% endif %}
            </div>
            
            <!-- Habit Dropout Predictions -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Habit Dropout Risk</h2>
                
                {% if at_risk_habits %}
                    <div class="space-y-4">
                        {% for risk_item in at_risk_habits %}
                            <div class="border rounded-lg p-4">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-gray-800">{{ risk_item.habit.name }}</h3>
                                    <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">
                                        High Risk
                                    </span>
                                </div>
                                <p class="text-gray-600 text-sm mt-2">{{ risk_item.reason }}</p>
                                <div class="mt-3">
                                    <a href="{{ url_for('habits.habit', habit_id=risk_item.habit.id) }}" 
                                       class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                                        View Habit
                                    </a>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-gray-600 text-center">No habits at risk of dropout detected.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Pass data from Jinja to JavaScript using hidden elements -->
{% if score_history %}
<div id="score-data" style="display: none;" 
     data-dates='{{ score_dates|tojson|safe }}'
     data-scores='{{ score_values|tojson|safe }}'></div>
{% endif %}

{% if wellbeing_insights %}
<div id="wellbeing-data" style="display: none;"
     data-score="{% if wellbeing_insights.wellbeing_score %}{{ wellbeing_insights.wellbeing_score }}{% else %}0{% endif %}"></div>
{% endif %}

<script>
    // Wait for DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Set correlation bar widths based on data-strength attribute
        document.querySelectorAll('.correlation-bar').forEach(function(bar) {
            const strength = bar.getAttribute('data-strength');
            if (strength) {
                bar.style.width = strength + '%';
            }
        });
        
        // Score chart rendering
        const scoreDataElement = document.getElementById('score-data');
        if (scoreDataElement) {
            const dates = JSON.parse(scoreDataElement.dataset.dates);
            const scores = JSON.parse(scoreDataElement.dataset.scores);
            
            const scoreData = [{
                x: dates,
                y: scores,
                type: 'scatter',
                mode: 'lines+markers',
                marker: { color: 'rgba(79, 70, 229, 1)' },
                line: { color: 'rgba(79, 70, 229, 0.8)', width: 3 }
            }];
            
            const scoreLayout = {
                margin: { t: 10, l: 40, r: 10, b: 40 },
                yaxis: { title: 'Score', range: [0, 100] },
                xaxis: { tickangle: -45 }
            };
            
            if (document.getElementById('scoreChart')) {
                Plotly.newPlot('scoreChart', scoreData, scoreLayout);
            }
        }
        
        // Wellbeing chart rendering
        const wellbeingDataElement = document.getElementById('wellbeing-data');
        if (wellbeingDataElement) {
            const score = parseInt(wellbeingDataElement.dataset.score, 10) || 0;
            
            const wellbeingData = [{
                type: 'indicator',
                mode: 'gauge+number',
                value: score,
                title: { text: 'Digital Wellbeing' },
                gauge: {
                    axis: { range: [0, 100] },
                    bar: { color: 'rgba(124, 58, 237, 0.8)' },
                    bgcolor: 'white',
                    borderwidth: 2,
                    bordercolor: 'lightgray',
                    steps: [
                        { range: [0, 30], color: 'rgba(239, 68, 68, 0.2)' },
                        { range: [30, 70], color: 'rgba(245, 158, 11, 0.2)' },
                        { range: [70, 100], color: 'rgba(16, 185, 129, 0.2)' }
                    ],
                    threshold: {
                        line: { color: 'purple', width: 4 },
                        thickness: 0.75,
                        value: score
                    }
                }
            }];

            const wellbeingLayout = {
                margin: { t: 0, r: 25, l: 25, b: 0 },
                height: 160,
                width: null,
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: { color: 'darkblue', family: 'Arial' }
            };

            if (document.getElementById('wellbeingChart')) {
                Plotly.newPlot('wellbeingChart', wellbeingData, wellbeingLayout);
            }
        }
    });
</script>
{% endblock %}
