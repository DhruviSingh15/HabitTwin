{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-5xl mx-auto">
        <!-- Dashboard Header -->
        <div class="bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 rounded-t-xl text-white p-8 shadow-lg">
            <div class="flex flex-col md:flex-row items-center justify-between">
                <div>
                    <div class="flex items-center mb-2">
                        <h1 class="text-3xl font-bold">Digital Wellbeing</h1>
                        <span class="ml-3 bg-white bg-opacity-20 text-xs px-2 py-1 rounded-full flex items-center">
                            <i class="fas fa-sync-alt mr-1"></i> Last updated: {{ today.strftime('%b %d, %Y') }}
                        </span>
                    </div>
                    <p class="text-blue-100 mb-3">Track and optimize your digital habits for better wellbeing</p>
                    <div class="flex items-center text-xs text-blue-100">
                        <span class="flex items-center mr-4">
                            <i class="fas fa-calendar-alt mr-1"></i> {{ today.strftime('%B %Y') }}
                        </span>
                        <span class="flex items-center">
                            <i class="fas fa-chart-line mr-1"></i> {{ screen_time_logs|length }} days tracked
                        </span>
                    </div>
                </div>
                <div class="mt-4 md:mt-0 flex flex-col sm:flex-row gap-3">
                    <a href="{{ url_for('wellbeing.digital_detox') }}" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-2 rounded-lg font-medium hover:from-purple-600 hover:to-pink-600 transition shadow-md flex items-center justify-center">
                        <i class="fas fa-moon mr-2"></i>Start Detox
                    </a>
                    <a href="{{ url_for('wellbeing.upload_screen_time') }}" class="bg-white text-indigo-600 px-4 py-2 rounded-lg font-medium hover:bg-blue-50 transition shadow-md flex items-center justify-center">
                        <i class="fas fa-upload mr-2"></i>Upload Data
                    </a>
                </div>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div class="bg-white rounded-b-xl shadow-lg p-8">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Total Screen Time -->
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-xl shadow-md border border-blue-100 hover:shadow-lg transition-all duration-300">
                    <div class="flex items-center justify-between mb-3">
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center" data-tooltip="Total time spent on digital devices">
                            <i class="fas fa-mobile-alt text-blue-600 text-xl"></i>
                        </div>
                        {% if total_screen_time > 35 %}
                            <span class="bg-red-100 text-red-700 text-xs px-2 py-1 rounded-full">High Usage</span>
                        {% elif total_screen_time > 21 %}
                            <span class="bg-yellow-100 text-yellow-700 text-xs px-2 py-1 rounded-full">Moderate</span>
                        {% else %}
                            <span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full">Healthy</span>
                        {% endif %}
                    </div>
                    <p class="text-sm text-blue-600 font-medium mb-1">Total Screen Time</p>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">{{ (total_screen_time / 60)|default(0)|round(1) }} hours</h3>
                    <div class="w-full bg-blue-200 rounded-full h-1.5 mb-2">
                        <div class="bg-blue-600 h-1.5 rounded-full" id="totalScreenTimeBar"></div>
                    </div>
                    <p class="text-xs text-gray-500">Last 7 days</p>
                </div>

                <!-- Daily Average -->
                <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 p-6 rounded-xl shadow-md border border-indigo-100 hover:shadow-lg transition-all duration-300">
                    <div class="flex items-center justify-between mb-3">
                        <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center" data-tooltip="Average daily screen time">
                            <i class="fas fa-chart-line text-indigo-600 text-xl"></i>
                        </div>
                        {% if daily_average > 5 %}
                            <span class="bg-red-100 text-red-700 text-xs px-2 py-1 rounded-full">High</span>
                        {% elif daily_average > 3 %}
                            <span class="bg-yellow-100 text-yellow-700 text-xs px-2 py-1 rounded-full">Moderate</span>
                        {% else %}
                            <span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full">Healthy</span>
                        {% endif %}
                    </div>
                    <p class="text-sm text-indigo-600 font-medium mb-1">Daily Average</p>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">{{ daily_average|default(0)|round(1) }} hours</h3>
                    <div class="w-full bg-indigo-200 rounded-full h-1.5 mb-2">
                        <div class="bg-indigo-600 h-1.5 rounded-full" id="dailyAverageBar"></div>
                    </div>
                    <p class="text-xs text-gray-500">{% if daily_average > 3 %}Try to reduce by 30min daily{% else %}Good balance!{% endif %}</p>
                </div>

                <!-- Most Used App -->
                <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-xl shadow-md border border-purple-100 hover:shadow-lg transition-all duration-300">
                    <div class="flex items-center justify-between mb-3">
                        <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center" data-tooltip="App with highest screen time">
                            <i class="fas fa-trophy text-purple-600 text-xl"></i>
                        </div>
                        {% if top_apps and top_apps[0][1] > 10 %}
                            <span class="bg-red-100 text-red-700 text-xs px-2 py-1 rounded-full">Heavy Use</span>
                        {% elif top_apps and top_apps[0][1] > 5 %}
                            <span class="bg-yellow-100 text-yellow-700 text-xs px-2 py-1 rounded-full">Moderate</span>
                        {% else %}
                            <span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full">Balanced</span>
                        {% endif %}
                    </div>
                    <p class="text-sm text-purple-600 font-medium mb-1">Most Used App</p>
                    <h3 class="text-xl font-bold text-gray-800 mb-2 truncate">
                        {% if top_apps %}
                            {{ top_apps[0][0] }}
                        {% else %}
                            No data
                        {% endif %}
                    </h3>
                    {% if top_apps %}
                        <p class="text-sm font-medium text-gray-700 mb-2">{{ (top_apps[0][1] / 60)|round(1) }} hours</p>
                    {% endif %}
                    <p class="text-xs text-gray-500">{% if top_apps and top_apps[0][1] > 480 %}Consider setting app limits{% else %}Good distribution{% endif %}</p>
                </div>

                <!-- Digital Wellbeing Score -->
                <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-xl shadow-md border border-green-100 hover:shadow-lg transition-all duration-300">
                    <div class="flex items-center justify-between mb-3">
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center" data-tooltip="Overall digital wellbeing score based on habits and screen time">
                            <i class="fas fa-heartbeat text-green-600 text-xl"></i>
                        </div>
                        {% set wellbeing_score = 100 - (daily_average * 10)|round|int if daily_average <= 10 else 0 %}
                        {% if wellbeing_score > 70 %}
                            <span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full">Excellent</span>
                        {% elif wellbeing_score > 40 %}
                            <span class="bg-yellow-100 text-yellow-700 text-xs px-2 py-1 rounded-full">Fair</span>
                        {% else %}
                            <span class="bg-red-100 text-red-700 text-xs px-2 py-1 rounded-full">Needs Work</span>
                        {% endif %}
                    </div>
                    <p class="text-sm text-green-600 font-medium mb-1">Wellbeing Score</p>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">{{ wellbeing_score }}/100</h3>
                    <div class="w-full bg-green-200 rounded-full h-1.5 mb-2">
                        <div class="bg-green-600 h-1.5 rounded-full" id="wellbeingScoreBar"></div>
                    </div>
                    <p class="text-xs text-gray-500">Based on screen time & habit balance</p>
                </div>
            </div>

            <!-- App Usage Breakdown -->
            <div class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">App Usage Breakdown</h2>
                    <div class="flex space-x-2">
                        <button id="viewListBtn" class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-l-lg hover:bg-indigo-200 transition-all text-sm active-view-btn" data-tooltip="View apps by usage time">
                            <i class="fas fa-list mr-1"></i> List
                        </button>
                        <button id="viewCategoryBtn" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-r-lg hover:bg-gray-200 transition-all text-sm" data-tooltip="View apps by category">
                            <i class="fas fa-th-large mr-1"></i> Category
                        </button>
                    </div>
                </div>
                
                {% if top_apps %}
                    <!-- List View -->
                    <div id="listView" class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="space-y-5">
                            {% for app, minutes in top_apps %}
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <div class="flex items-center">
                                            <div class="w-8 h-8 rounded-full flex items-center justify-center mr-3
                                                {% if loop.index == 1 %}
                                                    bg-red-100 text-red-600
                                                {% elif loop.index == 2 %}
                                                    bg-orange-100 text-orange-600
                                                {% elif loop.index == 3 %}
                                                    bg-yellow-100 text-yellow-600
                                                {% elif loop.index == 4 %}
                                                    bg-green-100 text-green-600
                                                {% elif loop.index == 5 %}
                                                    bg-blue-100 text-blue-600
                                                {% else %}
                                                    bg-purple-100 text-purple-600
                                                {% endif %}
                                            ">
                                                <i class="fas {% if 'social' in app.lower() %}fa-users
                                                    {% elif 'mail' in app.lower() or 'outlook' in app.lower() %}fa-envelope
                                                    {% elif 'netflix' in app.lower() or 'youtube' in app.lower() or 'prime' in app.lower() %}fa-film
                                                    {% elif 'game' in app.lower() %}fa-gamepad
                                                    {% elif 'music' in app.lower() or 'spotify' in app.lower() %}fa-music
                                                    {% elif 'chrome' in app.lower() or 'safari' in app.lower() or 'firefox' in app.lower() %}fa-globe
                                                    {% elif 'word' in app.lower() or 'docs' in app.lower() or 'office' in app.lower() %}fa-file-alt
                                                    {% else %}fa-mobile-alt{% endif %}"></i>
                                            </div>
                                            <div>
                                                <span class="text-gray-800 font-medium">{{ app }}</span>
                                                <div class="text-xs text-gray-500">
                                                    {% if 'social' in app.lower() %}Social Media
                                                    {% elif 'mail' in app.lower() or 'outlook' in app.lower() %}Communication
                                                    {% elif 'netflix' in app.lower() or 'youtube' in app.lower() or 'prime' in app.lower() %}Entertainment
                                                    {% elif 'game' in app.lower() %}Gaming
                                                    {% elif 'music' in app.lower() or 'spotify' in app.lower() %}Music
                                                    {% elif 'chrome' in app.lower() or 'safari' in app.lower() or 'firefox' in app.lower() %}Web Browsing
                                                    {% elif 'word' in app.lower() or 'docs' in app.lower() or 'office' in app.lower() %}Productivity
                                                    {% else %}Other{% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <span class="text-gray-700 font-medium">{{ (minutes / 60)|round(1) }} hours</span>
                                            <div class="text-xs text-gray-500">
                                                {{ (minutes / total_screen_time * 100)|round|int }}% of total
                                            </div>
                                        </div>
                                    </div>
                                    <div class="w-full bg-gray-100 rounded-full h-2.5">
                                        <div class="h-2.5 rounded-full {% if loop.index == 1 %}bg-gradient-to-r from-red-400 to-red-600
                                            {% elif loop.index == 2 %}bg-gradient-to-r from-orange-400 to-orange-600
                                            {% elif loop.index == 3 %}bg-gradient-to-r from-yellow-400 to-yellow-600
                                            {% elif loop.index == 4 %}bg-gradient-to-r from-green-400 to-green-600
                                            {% elif loop.index == 5 %}bg-gradient-to-r from-blue-400 to-blue-600
                                            {% else %}bg-gradient-to-r from-purple-400 to-purple-600{% endif %}" 
                                            id="appBar{{ loop.index }}"></div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Category View (initially hidden) -->
                    <div id="categoryView" class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hidden">
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                            {% set categories = {
                                'Social': {'minutes': 0, 'icon': 'fa-users', 'color': 'blue'},
                                'Entertainment': {'minutes': 0, 'icon': 'fa-film', 'color': 'purple'},
                                'Productivity': {'minutes': 0, 'icon': 'fa-briefcase', 'color': 'green'},
                                'Communication': {'minutes': 0, 'icon': 'fa-comments', 'color': 'yellow'},
                                'Gaming': {'minutes': 0, 'icon': 'fa-gamepad', 'color': 'red'},
                                'Other': {'minutes': 0, 'icon': 'fa-ellipsis-h', 'color': 'gray'}
                            } %}
                            
                            {% for app, minutes in top_apps %}
                                {% if 'social' in app.lower() or 'facebook' in app.lower() or 'instagram' in app.lower() or 'twitter' in app.lower() or 'tiktok' in app.lower() %}
                                    {% set _ = categories.update({'Social': {'minutes': categories['Social']['minutes'] + minutes, 'icon': 'fa-users', 'color': 'blue'}}) %}
                                {% elif 'netflix' in app.lower() or 'youtube' in app.lower() or 'prime' in app.lower() or 'disney' in app.lower() or 'hulu' in app.lower() or 'video' in app.lower() %}
                                    {% set _ = categories.update({'Entertainment': {'minutes': categories['Entertainment']['minutes'] + minutes, 'icon': 'fa-film', 'color': 'purple'}}) %}
                                {% elif 'word' in app.lower() or 'excel' in app.lower() or 'docs' in app.lower() or 'sheets' in app.lower() or 'office' in app.lower() or 'work' in app.lower() or 'notion' in app.lower() %}
                                    {% set _ = categories.update({'Productivity': {'minutes': categories['Productivity']['minutes'] + minutes, 'icon': 'fa-briefcase', 'color': 'green'}}) %}
                                {% elif 'mail' in app.lower() or 'outlook' in app.lower() or 'gmail' in app.lower() or 'message' in app.lower() or 'whatsapp' in app.lower() or 'telegram' in app.lower() or 'signal' in app.lower() %}
                                    {% set _ = categories.update({'Communication': {'minutes': categories['Communication']['minutes'] + minutes, 'icon': 'fa-comments', 'color': 'yellow'}}) %}
                                {% elif 'game' in app.lower() or 'play' in app.lower() or 'xbox' in app.lower() or 'playstation' in app.lower() or 'nintendo' in app.lower() %}
                                    {% set _ = categories.update({'Gaming': {'minutes': categories['Gaming']['minutes'] + minutes, 'icon': 'fa-gamepad', 'color': 'red'}}) %}
                                {% else %}
                                    {% set _ = categories.update({'Other': {'minutes': categories['Other']['minutes'] + minutes, 'icon': 'fa-ellipsis-h', 'color': 'gray'}}) %}
                                {% endif %}
                            {% endfor %}
                            
                            {% for category, data in categories.items() %}
                                {% if data.minutes > 0 %}
                                <div class="bg-{{ data.color }}-50 p-4 rounded-lg border border-{{ data.color }}-100 flex flex-col">
                                    <div class="flex justify-between items-center mb-3">
                                        <div class="flex items-center">
                                            <div class="w-10 h-10 rounded-full bg-{{ data.color }}-100 flex items-center justify-center text-{{ data.color }}-600 mr-3">
                                                <i class="fas {{ data.icon }}"></i>
                                            </div>
                                            <span class="font-medium text-gray-800">{{ category }}</span>
                                        </div>
                                        <span class="text-{{ data.color }}-600 font-bold">{{ (data.minutes / 60)|round(1) }}h</span>
                                    </div>
                                    <div class="w-full bg-{{ data.color }}-100 rounded-full h-2 mb-2">
                                        <div class="bg-{{ data.color }}-500 h-2 rounded-full" id="category{{ loop.index }}Bar"></div>
                                    </div>
                                    <div class="text-xs text-gray-500 text-right">
                                        {{ (data.minutes / total_screen_time * 100)|round|int }}% of total
                                    </div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                {% else %}
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 text-center">
                        <div class="text-gray-400 mb-4">
                            <i class="fas fa-chart-pie text-6xl"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">No App Usage Data</h3>
                        <p class="text-gray-500 mb-4">Upload your screen time data to see your app usage breakdown.</p>
                        <a href="{{ url_for('wellbeing.upload_screen_time') }}" class="inline-block bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-indigo-700 transition">
                            Upload Screen Time
                        </a>
                    </div>
                {% endif %}
            </div>

            <!-- Habits & Digital Wellbeing Integration -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Habits & Digital Wellbeing</h2>
                <div class="bg-gradient-to-r from-indigo-50 via-purple-50 to-pink-50 rounded-xl shadow-md p-6 border border-indigo-100">
                    <div class="flex flex-col lg:flex-row gap-6">
                        <!-- Digital-Physical Balance -->
                        <div class="lg:w-1/2">
                            <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-balance-scale text-indigo-600 mr-2"></i> Digital-Physical Balance
                            </h3>
                            <div class="bg-white rounded-lg p-4 shadow-sm">
                                <div class="flex justify-between items-center mb-3">
                                    <div>
                                        <span class="text-sm font-medium text-gray-700">Screen Time</span>
                                        <div class="text-xs text-gray-500">Digital Activities</div>
                                    </div>
                                    <div class="text-right">
                                        <span class="text-sm font-medium text-gray-700">Habit Time</span>
                                        <div class="text-xs text-gray-500">Physical Activities</div>
                                    </div>
                                </div>
                                
                                <!-- Balance Visualization -->
                                <div class="relative h-6 bg-gray-200 rounded-full overflow-hidden mb-2">
                                    {% set screen_percentage = 70 %}  <!-- This would be calculated based on actual data -->
                                    {% set habit_percentage = 100 - screen_percentage %}
                                    
                                    <div class="absolute top-0 left-0 h-full bg-gradient-to-r from-red-400 to-pink-400" id="screenTimeBalanceBar"></div>
                                    <div class="absolute top-0 right-0 h-full bg-gradient-to-r from-green-400 to-teal-400" id="habitTimeBalanceBar"></div>
                                    
                                    <div class="absolute top-0 left-0 w-full h-full flex items-center justify-center text-xs font-medium text-white">
                                        <span id="balanceText">{{ screen_percentage }}% / {{ habit_percentage }}%</span>
                                    </div>
                                </div>
                                
                                <div class="flex justify-between text-xs text-gray-500">
                                    <span>Digital Heavy</span>
                                    <span>Balanced</span>
                                    <span>Physical Focus</span>
                                </div>
                                
                                <div class="mt-4 p-3 rounded-lg {% if screen_percentage > 65 %}bg-red-50 text-red-800{% elif screen_percentage < 45 %}bg-green-50 text-green-800{% else %}bg-blue-50 text-blue-800{% endif %}">
                                    <p class="text-sm">
                                        {% if screen_percentage > 65 %}
                                            <i class="fas fa-exclamation-circle mr-1"></i> Your digital time is outweighing physical activities. Try to balance this by increasing habit-focused time.
                                        {% elif screen_percentage < 45 %}
                                            <i class="fas fa-check-circle mr-1"></i> Great job! You're prioritizing physical activities over screen time.
                                        {% else %}
                                            <i class="fas fa-info-circle mr-1"></i> You have a good balance between digital and physical activities.
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Habit Completion vs Screen Time -->
                        <div class="lg:w-1/2">
                            <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-chart-line text-purple-600 mr-2"></i> Habit Completion vs Screen Time
                            </h3>
                            <div class="bg-white rounded-lg p-4 shadow-sm">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="text-center px-4 py-3 bg-indigo-50 rounded-lg">
                                        <p class="text-sm text-gray-600 mb-1">Habit Completion</p>
                                        <p class="text-xl font-bold text-indigo-600">75%</p>
                                    </div>
                                    <div class="text-center">
                                        <i class="fas fa-exchange-alt text-gray-400 text-xl"></i>
                                    </div>
                                    <div class="text-center px-4 py-3 bg-pink-50 rounded-lg">
                                        <p class="text-sm text-gray-600 mb-1">Screen Time</p>
                                        <p class="text-xl font-bold text-pink-600">{{ daily_average|round(1) }}h</p>
                                    </div>
                                </div>
                                
                                <div class="space-y-3">
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="text-gray-700">Low Screen Days</span>
                                            <span class="text-green-600 font-medium">85% habit completion</span>
                                        </div>
                                        <div class="w-full bg-gray-100 rounded-full h-2">
                                            <div class="bg-green-500 h-2 rounded-full" style="width: 85%"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="text-gray-700">Medium Screen Days</span>
                                            <span class="text-yellow-600 font-medium">70% habit completion</span>
                                        </div>
                                        <div class="w-full bg-gray-100 rounded-full h-2">
                                            <div class="bg-yellow-500 h-2 rounded-full" style="width: 70%"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="text-gray-700">High Screen Days</span>
                                            <span class="text-red-600 font-medium">45% habit completion</span>
                                        </div>
                                        <div class="w-full bg-gray-100 rounded-full h-2">
                                            <div class="bg-red-500 h-2 rounded-full" style="width: 45%"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-4 p-3 rounded-lg bg-purple-50 text-purple-800 text-sm">
                                    <i class="fas fa-lightbulb mr-1"></i> <strong>Insight:</strong> On days with lower screen time, your habit completion rate increases by approximately 40%.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Screen Time Logs -->
            <div class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Recent Screen Time Logs</h2>
                    {% if screen_time_logs %}
                    <a href="#" id="exportDataBtn" class="text-indigo-600 hover:text-indigo-800 text-sm flex items-center">
                        <i class="fas fa-download mr-1"></i> Export Data
                    </a>
                    {% endif %}
                </div>
                
                {% if screen_time_logs %}
                    <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="bg-gray-50 text-gray-700 text-sm">
                                    <tr>
                                        <th class="py-3 px-4 text-left font-medium">Date</th>
                                        <th class="py-3 px-4 text-left font-medium">Screen Time</th>
                                        <th class="py-3 px-4 text-left font-medium">Top App</th>
                                        <th class="py-3 px-4 text-left font-medium">Habits Completed</th>
                                        <th class="py-3 px-4 text-left font-medium">Status</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    {% for log in screen_time_logs[:7] %}  <!-- Limit to 7 most recent logs -->
                                        <tr class="hover:bg-gray-50 text-sm">
                                            <td class="py-3 px-4">
                                                <div class="font-medium text-gray-800">{{ log.date.strftime('%a, %b %d') if log.date else 'N/A' }}</div>
                                                <div class="text-xs text-gray-500">{{ log.date.strftime('%Y') if log.date else '' }}</div>
                                            </td>
                                            <td class="py-3 px-4">
                                                <div class="font-medium {% if log.usage_minutes > 300 %}text-red-600{% elif log.usage_minutes > 180 %}text-yellow-600{% else %}text-green-600{% endif %}">
                                                    {{ (log.usage_minutes / 60)|default(0)|round(1) }} hours
                                                </div>
                                                <div class="w-16 bg-gray-200 rounded-full h-1.5 mt-1">
                                                    <div id="logBar{{ loop.index }}" class="{% if log.usage_minutes > 300 %}bg-red-500{% elif log.usage_minutes > 180 %}bg-yellow-500{% else %}bg-green-500{% endif %} h-1.5 rounded-full" data-width="{% if (log.usage_minutes / 480 * 100) > 100 %}100{% else %}{{ (log.usage_minutes / 480 * 100)|round }}{% endif %}"></div>
                                                </div>
                                            </td>
                                            <td class="py-3 px-4">
                                                <div class="flex items-center">
                                                    <div class="w-6 h-6 rounded-full flex items-center justify-center mr-2 {% if 'social' in log.top_app|lower() %}bg-blue-100 text-blue-600
                                                        {% elif 'netflix' in log.top_app|lower() or 'youtube' in log.top_app|lower() %}bg-purple-100 text-purple-600
                                                        {% elif 'game' in log.top_app|lower() %}bg-red-100 text-red-600
                                                        {% else %}bg-gray-100 text-gray-600{% endif %}">
                                                        <i class="fas {% if 'social' in log.top_app|lower() %}fa-users
                                                            {% elif 'netflix' in log.top_app|lower() or 'youtube' in log.top_app|lower() %}fa-film
                                                            {% elif 'game' in log.top_app|lower() %}fa-gamepad
                                                            {% else %}fa-mobile-alt{% endif %} text-xs"></i>
                                                    </div>
                                                    {{ log.top_app or 'N/A' }}
                                                </div>
                                            </td>
                                            <td class="py-3 px-4">
                                                <!-- This would be actual data from habits completed on that day -->
                                                {% set habits_completed = [3, 2, 4, 1, 5, 3, 2][loop.index0 % 7] %}
                                                {% set total_habits = [5, 5, 5, 5, 6, 6, 4][loop.index0 % 7] %}
                                                <div class="font-medium text-gray-800">{{ habits_completed }}/{{ total_habits }}</div>
                                                <div class="w-16 bg-gray-200 rounded-full h-1.5 mt-1">
                                                    <div id="habitBar{{ loop.index }}" class="bg-indigo-500 h-1.5 rounded-full" data-width="{{ (habits_completed / total_habits * 100)|round }}"></div>
                                                </div>
                                            </td>
                                            <td class="py-3 px-4">
                                                {% if log.usage_minutes < 180 and habits_completed / total_habits > 0.7 %}
                                                    <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800 font-medium">Excellent</span>
                                                {% elif log.usage_minutes > 300 and habits_completed / total_habits < 0.5 %}
                                                    <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800 font-medium">Needs Work</span>
                                                {% else %}
                                                    <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800 font-medium">Balanced</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% if screen_time_logs|length > 7 %}
                            <div class="bg-gray-50 px-4 py-3 text-center">
                                <a href="#" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                                    View All {{ screen_time_logs|length }} Logs
                                </a>
                            </div>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 text-center">
                        <div class="text-gray-400 mb-4">
                            <i class="fas fa-history text-6xl"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">No Screen Time Logs</h3>
                        <p class="text-gray-500 mb-4">Upload your screen time data to see your usage history.</p>
                        <a href="{{ url_for('wellbeing.upload_screen_time') }}" class="inline-block bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-indigo-700 transition">
                            Upload Screen Time
                        </a>
                    </div>
                {% endif %}
            </div>

            <!-- Digital Wellbeing Tips & Actions -->
            <div class="mb-8 grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2 bg-gradient-to-br from-indigo-50 to-indigo-100 p-6 rounded-xl shadow-md border border-indigo-100">
                    <h3 class="text-xl font-bold text-indigo-800 mb-4 flex items-center">
                        <i class="fas fa-lightbulb text-indigo-600 mr-2"></i> Personalized Wellbeing Tips
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="flex items-start">
                                <div class="bg-blue-100 rounded-full p-2 mr-3 text-blue-600" data-tooltip="Helps improve sleep quality">
                                    <i class="fas fa-moon"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">Digital Sunset</h4>
                                    <p class="text-sm text-gray-600">Set a "digital sunset" time 1 hour before bed. Put away all devices to improve sleep quality.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="flex items-start">
                                <div class="bg-green-100 rounded-full p-2 mr-3 text-green-600" data-tooltip="Reduces eye strain during screen time">
                                    <i class="fas fa-hourglass-half"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">20-20-20 Rule</h4>
                                    <p class="text-sm text-gray-600">Every 20 minutes, look at something 20 feet away for 20 seconds to reduce eye strain.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="flex items-start">
                                <div class="bg-purple-100 rounded-full p-2 mr-3 text-purple-600">
                                    <i class="fas fa-bell-slash"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">Notification Detox</h4>
                                    <p class="text-sm text-gray-600">Disable non-essential notifications to reduce distractions and improve focus.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="flex items-start">
                                <div class="bg-yellow-100 rounded-full p-2 mr-3 text-yellow-600">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">Social Media Limits</h4>
                                    <p class="text-sm text-gray-600">Limit social media use to specific times of day to reduce anxiety and comparison.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-br from-purple-50 to-pink-50 p-6 rounded-xl shadow-md border border-purple-100">
                    <h3 class="text-xl font-bold text-purple-800 mb-4 flex items-center">
                        <i class="fas fa-rocket text-purple-600 mr-2"></i> Take Action
                    </h3>
                    <div class="space-y-3">
                        <a href="{{ url_for('wellbeing.digital_detox') }}" class="flex items-center p-3 bg-white rounded-lg shadow-sm hover:shadow-md transition-all">
                            <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 mr-3">
                                <i class="fas fa-moon"></i>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800">Start Digital Detox</h4>
                                <p class="text-xs text-gray-500">Take a break from screens</p>
                            </div>
                            <i class="fas fa-chevron-right ml-auto text-gray-400"></i>
                        </a>
                        
                        <a href="{{ url_for('wellbeing.app_limits') }}" class="flex items-center p-3 bg-white rounded-lg shadow-sm hover:shadow-md transition-all">
                            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 mr-3">
                                <i class="fas fa-sliders-h"></i>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800">Set App Limits</h4>
                                <p class="text-xs text-gray-500">Control time spent on apps</p>
                            </div>
                            <i class="fas fa-chevron-right ml-auto text-gray-400"></i>
                        </a>
                        
                        <a href="#" class="flex items-center p-3 bg-white rounded-lg shadow-sm hover:shadow-md transition-all">
                            <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600 mr-3">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800">Track Progress</h4>
                                <p class="text-xs text-gray-500">View your wellbeing journey</p>
                            </div>
                            <i class="fas fa-chevron-right ml-auto text-gray-400"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
    
{% block scripts %}
    <!-- Add data attributes to store template variables for JavaScript -->
    <div id="appData" 
        data-top-apps='{{ top_apps|tojson if top_apps else "[]" }}' 
        data-wellbeing-score='{{ wellbeing_score|default(65) }}'
        style="display: none;"></div>
        
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize progress bars with animations
            initProgressBars();
            
            // Initialize view toggles for app usage section
            initViewToggles();
            
            // Initialize balance bars
            initBalanceBars();
            
            // Initialize log and habit bars
            initLogBars();
            
            // Initialize export functionality
            initExportFunctionality();
            
            // Initialize tooltips
            initTooltips();
        });
        
        function initProgressBars() {
            // Get data from data attributes
            const appData = document.getElementById('appData');
            let topApps = [];
            let wellbeingScore = 65; // Default value
            
            if (appData) {
                try {
                    topApps = JSON.parse(appData.dataset.topApps || '[]');
                    wellbeingScore = parseInt(appData.dataset.wellbeingScore || '65');
                } catch (e) {
                    console.error('Error parsing app data:', e);
                }
            }
            
            // Animate the app usage bars
            const appBars = document.querySelectorAll('[id^="appBar"]');
            appBars.forEach((bar, index) => {
                let percentage = 0;
                
                if (topApps.length > 0 && index < topApps.length) {
                    const topAppValue = topApps[0][1];
                    if (topAppValue > 0) {
                        percentage = (topApps[index][1] / topAppValue) * 100;
                    }
                } else {
                    // Default animation if no data
                    percentage = Math.max(10, 90 - (index * 15));
                }
                
                setTimeout(() => {
                    bar.style.width = `${percentage}%`;
                }, 300 + (index * 100));
            });
            
            // Animate category bars
            const categoryBars = document.querySelectorAll('[id^="category"]');
            categoryBars.forEach((bar, index) => {
                setTimeout(() => {
                    // This would be calculated based on actual data
                    const percentage = [85, 65, 45, 30, 20, 10][index % 6];
                    bar.style.width = `${percentage}%`;
                }, 300 + (index * 100));
            });
            
            // Animate wellbeing score circle
            const scoreCircle = document.getElementById('wellbeingScoreCircle');
            if (scoreCircle) {
                setTimeout(() => {
                    scoreCircle.style.strokeDasharray = `${wellbeingScore}, 100`;
                }, 500);
            }
        }
        
        function initViewToggles() {
            const listViewBtn = document.getElementById('viewListBtn');
            const categoryViewBtn = document.getElementById('viewCategoryBtn');
            const listView = document.getElementById('listView');
            const categoryView = document.getElementById('categoryView');
            
            if (listViewBtn && categoryViewBtn && listView && categoryView) {
                listViewBtn.addEventListener('click', function() {
                    listView.classList.remove('hidden');
                    categoryView.classList.add('hidden');
                    listViewBtn.classList.add('bg-indigo-100', 'text-indigo-700');
                    listViewBtn.classList.remove('bg-gray-100', 'text-gray-700');
                    categoryViewBtn.classList.add('bg-gray-100', 'text-gray-700');
                    categoryViewBtn.classList.remove('bg-indigo-100', 'text-indigo-700');
                });
                
                categoryViewBtn.addEventListener('click', function() {
                    categoryView.classList.remove('hidden');
                    listView.classList.add('hidden');
                    categoryViewBtn.classList.add('bg-indigo-100', 'text-indigo-700');
                    categoryViewBtn.classList.remove('bg-gray-100', 'text-gray-700');
                    listViewBtn.classList.add('bg-gray-100', 'text-gray-700');
                    listViewBtn.classList.remove('bg-indigo-100', 'text-indigo-700');
                    
                    // Re-initialize category bars when view is shown
                    initProgressBars();
                });
            }
        }
        
        function initBalanceBars() {
            // Set up the digital-physical balance visualization
            const screenBar = document.getElementById('screenTimeBalanceBar');
            const habitBar = document.getElementById('habitTimeBalanceBar');
            const balanceText = document.getElementById('balanceText');
            
            if (screenBar && habitBar) {
                // This would be calculated based on actual data
                const screenPercentage = 70;
                const habitPercentage = 100 - screenPercentage;
                
                setTimeout(() => {
                    screenBar.style.width = `${screenPercentage}%`;
                    habitBar.style.width = `${habitPercentage}%`;
                    
                    // Update balance text if present
                    if (balanceText) {
                        if (screenPercentage > 75) {
                            balanceText.textContent = 'Digital Heavy';
                            balanceText.className = 'text-red-600 font-medium';
                        } else if (screenPercentage > 50) {
                            balanceText.textContent = 'Digital Leaning';
                            balanceText.className = 'text-yellow-600 font-medium';
                        } else if (screenPercentage > 40) {
                            balanceText.textContent = 'Balanced';
                            balanceText.className = 'text-green-600 font-medium';
                        } else {
                            balanceText.textContent = 'Physical Focused';
                            balanceText.className = 'text-blue-600 font-medium';
                        }
                    }
                }, 500);
            }
        }
        
        function initLogBars() {
            // Animate log bars
            const logBars = document.querySelectorAll('[id^="logBar"]');
            logBars.forEach((bar, index) => {
                const width = bar.getAttribute('data-width');
                setTimeout(() => {
                    bar.style.width = `${width}%`;
                }, 300 + (index * 50));
            });
            
            // Animate habit bars
            const habitBars = document.querySelectorAll('[id^="habitBar"]');
            habitBars.forEach((bar, index) => {
                const width = bar.getAttribute('data-width');
                setTimeout(() => {
                    bar.style.width = `${width}%`;
                }, 300 + (index * 50));
            });
        }
        
        function initExportFunctionality() {
            const exportBtn = document.getElementById('exportDataBtn');
            if (exportBtn) {
                exportBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Get table data
                    const table = document.querySelector('table');
                    if (!table) return;
                    
                    let csvContent = "data:text/csv;charset=utf-8,";
                    
                    // Add headers
                    const headers = [];
                    table.querySelectorAll('thead th').forEach(th => {
                        headers.push(th.textContent.trim());
                    });
                    csvContent += headers.join(',') + "\r\n";
                    
                    // Add rows
                    table.querySelectorAll('tbody tr').forEach(tr => {
                        const row = [];
                        tr.querySelectorAll('td').forEach(td => {
                            // Get just the text content without child elements
                            let content = td.textContent.trim().replace(/,/g, ' ');
                            row.push(content);
                        });
                        csvContent += row.join(',') + "\r\n";
                    });
                    
                    // Create download link
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", "screen_time_logs.csv");
                    document.body.appendChild(link);
                    
                    // Trigger download and remove link
                    link.click();
                    document.body.removeChild(link);
                    
                    // Show success message
                    showToast('Screen time data exported successfully!', 'success');
                });
            }
        }
        
        function initTooltips() {
            // Add tooltip functionality to elements with data-tooltip attribute
            const tooltipElements = document.querySelectorAll('[data-tooltip]');
            tooltipElements.forEach(el => {
                el.addEventListener('mouseenter', function() {
                    const tooltipText = this.getAttribute('data-tooltip');
                    const tooltip = document.createElement('div');
                    tooltip.className = 'absolute bg-gray-800 text-white text-xs rounded py-1 px-2 z-50';
                    tooltip.style.bottom = 'calc(100% + 5px)';
                    tooltip.style.left = '50%';
                    tooltip.style.transform = 'translateX(-50%)';
                    tooltip.style.whiteSpace = 'nowrap';
                    tooltip.textContent = tooltipText;
                    
                    // Add arrow
                    const arrow = document.createElement('div');
                    arrow.className = 'absolute w-2 h-2 bg-gray-800 transform rotate-45';
                    arrow.style.bottom = '-4px';
                    arrow.style.left = 'calc(50% - 4px)';
                    tooltip.appendChild(arrow);
                    
                    // Position the tooltip relative to the element
                    this.style.position = 'relative';
                    this.appendChild(tooltip);
                });
                
                el.addEventListener('mouseleave', function() {
                    const tooltip = this.querySelector('div.absolute');
                    if (tooltip) this.removeChild(tooltip);
                });
            });
        }
        
        function showToast(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-y-20 opacity-0 ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            toast.textContent = message;
            
            // Add to document
            document.body.appendChild(toast);
            
            // Show toast with animation
            setTimeout(() => {
                toast.classList.remove('translate-y-20', 'opacity-0');
            }, 10);
            
            // Hide toast after 3 seconds
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
    </script>
{% endblock scripts %}

{% endblock content %}
